#!/usr/bin/env node
import fs from "node:fs";
import path from "node:path";
import nacl from "tweetnacl";
import naclUtil from "tweetnacl-util";

const { encodeBase64 } = naclUtil;

// base64url helper
function b64u(bytes) {
  return encodeBase64(bytes)
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

const outFile = process.argv[2];
if (!outFile) {
  console.error("Usage: whisper-keygen.js <output.json>");
  process.exit(1);
}

// Ensure parent dir exists
fs.mkdirSync(path.dirname(outFile), { recursive: true });

// Generate keys
const ed = nacl.sign.keyPair(); // ed25519
const x  = nacl.box.keyPair();  // x25519

const out = {
  usage: "whisper",
  generated_at: new Date().toISOString(),
  public: {
    ed25519_b64u: b64u(ed.publicKey),
    x25519_b64u:  b64u(x.publicKey),
  },
  private: {
    ed25519_sk_b64u: b64u(ed.secretKey),
    x25519_sk_b64u:  b64u(x.secretKey),
  }
};

fs.writeFileSync(outFile, JSON.stringify(out, null, 2));
console.log(`✅ Whisper keys generated: ${outFile}`);
console.log(`⚠️  KEEP THIS FILE SECRET`);

