#!/usr/bin/env node
import { createRequire } from "node:module";
const require = createRequire(import.meta.url);

const sodium = require("libsodium-wrappers");   // force CJS entry
await sodium.ready;


//import sodium from "libsodium-wrappers";
//import fs from "fs";

//await sodium.ready;

// ===== generate keys =====
const ed = sodium.crypto_sign_keypair();        // ed25519
const x  = sodium.crypto_box_keypair();         // x25519

// ===== encode helpers =====
const b64u = (buf) =>
  Buffer.from(buf)
    .toString("base64")
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/, "");

// ===== output =====
const out = {
  usage: "whisper",
  generated_at: new Date().toISOString(),

  public: {
    ed25519_spki_b64u: b64u(ed.publicKey),
    x25519_spki_b64u:  b64u(x.publicKey),
  },

  private: {
    ed25519_sk_b64u: b64u(ed.privateKey),
    x25519_sk_b64u:  b64u(x.privateKey),
  }
};

const filename = process.argv[2] || "alice.keys.json";
fs.writeFileSync(filename, JSON.stringify(out, null, 2));

console.log(`✅ Keys generated: ${filename}`);
console.log(`   ⚠️ KEEP THIS FILE SECRET (private keys inside)`);

